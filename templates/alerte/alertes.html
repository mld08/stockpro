{% extends "base.html" %}

{% block title %}Alertes - Gestion Comptabilité Matière{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-red-50 via-white to-orange-50">
    <div class="px-4 sm:px-6 lg:px-8 py-8">
        <div class="max-w-7xl mx-auto">
            <!-- Page Header -->
            <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-exclamation-triangle mr-3 text-red-600"></i>
                        Alertes de Stock
                    </h1>
                    <p class="text-gray-600">Surveillez vos niveaux de stock critiques et gérez les alertes</p>
                    <div class="mt-3 flex items-center space-x-4">
                        <div class="flex items-center text-sm">
                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                            <span class="text-red-700 font-medium">{{ alertes|length }} alertes nouvelles</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                            Dernière mise à jour: maintenant
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="refreshAlertes()" 
                            class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-300 shadow-sm">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualiser
                    </button>
                </div>
            </div>

            <!-- Liste des alertes -->
            {% if alertes %}
            <div class="space-y-4">
                {% for alerte, produit in alertes %}
                {% set is_critique = produit.stock_actuel <= produit.seuil_min %}
                {% set is_bas = produit.stock_actuel <= produit.seuil_min * 1.5 %}
                <div class="glass-effect rounded-2xl overflow-hidden hover-lift transition-all duration-300 border-l-4 
                            {{ 'border-red-500' if is_critique else 'border-orange-500' if is_bas else 'border-yellow-500' }}">
                    <div class="p-6">
                        <div class="flex items-start space-x-4">
                            <!-- Icône de priorité -->
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center
                                            {{ 'bg-red-100 text-red-600' if is_critique else 
                                               'bg-orange-100 text-orange-600' if is_bas else 
                                               'bg-yellow-100 text-yellow-600' }}">
                                    <i class="fas {{ 'fa-exclamation-triangle' if is_critique else 
                                                     'fa-exclamation-circle' if is_bas else 
                                                     'fa-info-circle' }} text-xl"></i>
                                </div>
                            </div>

                            <!-- Contenu de l'alerte -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-gray-900">
                                        {{ alerte.message }}
                                    </h3>
                                    <div class="flex items-center space-x-3">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                                     {{ 'bg-red-100 text-red-800' if is_critique else 
                                                        'bg-orange-100 text-orange-800' if is_bas else 
                                                        'bg-yellow-100 text-yellow-800' }}">
                                            {{ 'Critique' if is_critique else 'Stock bas' if is_bas else 'Attention' }}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                                     {{ 'bg-blue-100 text-blue-800' if alerte.statut == 'NOUVELLE' else 'bg-gray-100 text-gray-800' }}">
                                            {{ alerte.statut.title() }}
                                        </span>
                                        <span class="text-sm text-gray-500">
                                            <i class="fas fa-clock mr-1"></i>
                                            {{ alerte.date_alerte.strftime('%d/%m/%Y à %H:%M') }}
                                        </span>
                                    </div>
                                </div>

                                <!-- Informations du produit -->
                                <div class="bg-gray-50 rounded-xl p-4 mb-4">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">Produit</label>
                                            <div class="flex items-center">
                                                <i class="fas fa-box text-primary-600 mr-2"></i>
                                                <span class="font-semibold">{{ produit.nom }}</span>
                                            </div>
                                            <div class="text-sm text-gray-500">Code: {{ produit.code }}</div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">Stock Actuel</label>
                                            <div class="text-2xl font-bold 
                                                        {{ 'text-red-600' if produit.stock_actuel <= produit.seuil_min else 
                                                           'text-orange-600' if produit.stock_actuel <= produit.seuil_min * 1.5 else 
                                                           'text-green-600' }}">
                                                {{ produit.stock_actuel }}
                                                <span class="text-sm font-normal text-gray-500">{{ produit.unite or 'unité' }}</span>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">Seuil Minimum</label>
                                            <div class="text-lg font-semibold text-gray-800">
                                                {{ produit.seuil_min }}
                                                <span class="text-sm font-normal text-gray-500">{{ produit.unite or 'unité' }}</span>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">Barre de progression</label>
                                            <div class="w-full bg-gray-200 rounded-full h-3">
                                                {% set stock_percentage = (produit.stock_actuel / (produit.seuil_min * 3) * 100) if produit.seuil_min > 0 else 0 %}
                                                <div class="h-3 rounded-full transition-all duration-500
                                                            {{ 'bg-red-500' if stock_percentage < 33 else 
                                                               'bg-orange-500' if stock_percentage < 66 else 
                                                               'bg-green-500' }}"
                                                     style="width: {{ [stock_percentage, 100]|min }}%"></div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                {{ "%.1f"|format(stock_percentage) }}% du niveau optimal
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <!-- <div class="flex flex-wrap gap-3">
                                    <a href="/produit/{{ produit.id_produit }}/modifier" 
                                       class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 text-sm font-medium">
                                        <i class="fas fa-edit mr-2"></i>
                                        Modifier le produit
                                    </a>
                                    
                                    <button onclick="supprimerAlerte({{ alerte.id_alerte }})"
                                            class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm font-medium">
                                        <i class="fas fa-trash mr-2"></i>
                                        Supprimer
                                    </button>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% else %}
            <!-- État vide -->
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-check-circle text-green-600 text-4xl"></i>
                </div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-3">Aucune alerte active</h3>
                <p class="text-gray-500 mb-6 max-w-md mx-auto">
                    Excellente nouvelle ! Tous vos niveaux de stock sont dans les normes. 
                    Continuez votre bon travail de gestion.
                </p>
                <a href="{{ url_for('produits') }}" 
                   class="inline-flex items-center px-6 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 font-medium transition-colors duration-200">
                    <i class="fas fa-boxes mr-2"></i>
                    Voir les produits
                </a>
            </div>
            {% endif %}

            <!-- Statistiques rapides -->
            {% if alertes %}
            <div class="mt-12 grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-bell text-blue-600 text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-blue-600">{{ alertes|length }}</h3>
                    <p class="text-gray-600">Total alertes</p>
                </div>
                
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                    {% set critiques = alertes|selectattr('1.stock_actuel', 'le', alertes[0][1].seuil_min if alertes else 0)|list %}
                    <h3 class="text-2xl font-bold text-red-600">{{ critiques|length if critiques else 0 }}</h3>
                    <p class="text-gray-600">Stock critique</p>
                </div>
                
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-green-600">{{ alertes_traites }}</h3>
                    <p class="text-gray-600">Traitées</p>
                </div>
                
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clock text-orange-600 text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-orange-600">{{ alertes|selectattr('0.statut', 'equalto', 'NOUVELLE')|list|length }}</h3>
                    <p class="text-gray-600">Nouvelles</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Scripts JavaScript pour les interactions -->
<script>
function refreshAlertes() {
    location.reload();
}

function supprimerAlerte(alerteId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette alerte ?')) {
        fetch(`/alerte/${alerteId}/supprimer`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(() => {
            location.reload();
        });
    }
}

// Auto-refresh toutes les 5 minutes
setInterval(refreshAlertes, 300000);
</script>

{% endblock %}